syntax = "proto3";

package node;

option go_package = "./proto";

// Basic RPC interface for chorus nodes
service NodeService {
  // Ping exchanges peer information for gossip
  rpc Ping(PingRequest) returns (PingResponse);

  // Fetch returns the owner of a key (for routing)
  rpc Fetch(FetchRequest) returns (FetchResponse);

  // Put stores a value for a key (must be sent to owner node)
  rpc Put(PutRequest) returns (PutResponse);

  // Get retrieves a value for a key (must be sent to owner node)
  rpc Get(GetRequest) returns (GetResponse);

  // Echo sends a message and gets a response
  rpc Echo(EchoRequest) returns (EchoResponse);
}

// PeerInfo contains information about a peer node
message PeerInfo {
  string id = 1;        // node ID (e.g., "node1")
  string addr = 2;      // address (e.g., "localhost:8010")
  int64 heartbeat = 3;  // heartbeat counter
}

message PingRequest {
  string node_id = 1;
  repeated PeerInfo peers = 2;  // all known peers including self
}

message PingResponse {
  string node_id = 1;
  int64 timestamp = 2;
  repeated PeerInfo peers = 3;  // merged peer info
}

message FetchRequest {
  string key = 1;
}

message FetchResponse {
  string owner_id = 1;      // node ID that owns this key
  string owner_addr = 2;    // address of the owner
  uint32 ring_fingerprint = 3;  // hash of membership - same fingerprint = same ring
}

message EchoRequest {
  string node_id = 1;
  string message = 2;
  int32 hop_count = 3;
}

message EchoResponse {
  string node_id = 1;
  string message = 2;
  int32 hop_count = 3;
}

message PutRequest {
  string key = 1;
  bytes value = 2;
}

message PutResponse {
  bool stored = 1;          // true if this node stored the value
  string owner_id = 2;      // if not stored: the actual owner
  string owner_addr = 3;    // if not stored: owner's address for redirect
}

message GetRequest {
  string key = 1;
}

message GetResponse {
  bool found = 1;           // true if key exists on this node
  bytes value = 2;          // the value (if found)
  string owner_id = 3;      // if wrong node: the actual owner
  string owner_addr = 4;    // if wrong node: owner's address for redirect
}
